<!doctype html>
<html lang="ru">
<head>
  <meta charset="utf-8" />
  <meta name="viewport" content="width=device-width, initial-scale=1" />
  <title>InitData capture</title>
  <style>
    :root {
      /* Фолбэки на случай, если тему не подставили */
      --bg: #0b0b0b;
      --text: #ffffff;
      --muted: #8a8a8a;
      --card: #141414;
      --border: #2a2a2a;
      --btn: #2f2f2f;
      --btn-hover: #3b3b3b;
    }
    /* Используем телеграмовские переменные, если есть */
    body {
      background: var(--tg-theme-bg-color, var(--bg));
      color: var(--tg-theme-text-color, var(--text));
      font-family: ui-monospace, SFMono-Regular, Menlo, Consolas, "Liberation Mono", monospace;
      margin: 0;
      padding: 16px;
      line-height: 1.4;
    }
    h3 {
      margin: 0 0 12px;
    }
    .row { margin: 8px 0 16px; color: var(--tg-theme-hint-color, var(--muted)); }
    pre#out {
      background: var(--tg-theme-secondary-bg-color, var(--card));
      border: 1px solid var(--tg-theme-hint-color, var(--border));
      border-radius: 10px;
      padding: 12px;
      white-space: pre-wrap;
      word-break: break-all;
      min-height: 120px;
      margin: 0 0 12px;
    }
    button {
      background: var(--tg-theme-button-color, var(--btn));
      color: var(--tg-theme-button-text-color, #fff);
      border: 0;
      border-radius: 10px;
      padding: 10px 16px;
      cursor: pointer;
      font-weight: 600;
    }
    button:hover { filter: brightness(1.05); background: var(--btn-hover); }
    .small { font-size: 12px; color: var(--tg-theme-hint-color, var(--muted)); }
  </style>
</head>
<body>
  <h3>Telegram initData</h3>
  <div class="row small" id="meta">Загрузка…</div>
  <pre id="out">(empty)</pre>
  <button id="copy">Copy</button>
  <div class="row small" id="tips"></div>

  <script>
    const tg = window.Telegram && window.Telegram.WebApp;

    function readInitData() {
      const viaAPI = tg?.initData || "";
      const viaQS  = new URLSearchParams(location.search).get("tgWebAppData") || "";
      // приоритет у initData из API; если пусто — берём из QS
      return viaAPI || viaQS || "";
    }

    function render() {
      const data = readInitData();
      const meta = [];
      meta.push(`theme: ${tg?.colorScheme || "unknown"}`);
      meta.push(`via API length: ${(tg?.initData || "").length}`);
      meta.push(`via QS length: ${(new URLSearchParams(location.search).get("tgWebAppData") || "").length}`);
      document.getElementById("meta").textContent = meta.join(" | ");

      const out = document.getElementById("out");
      out.textContent = data || "(empty)";

      const tips = document.getElementById("tips");
      tips.textContent = data
        ? "Готово: можно копировать и использовать в Postman как init_data."
        : "Похоже, initData пустой. Убедитесь, что страница открыта из бота через Menu Button/StartApp, а не просто в браузере.";
    }

    async function copyInitData() {
      const text = document.getElementById("out").textContent || "";
      let ok = false;

      // 1) Современный путь
      if (!ok && navigator.clipboard && window.isSecureContext) {
        try { await navigator.clipboard.writeText(text); ok = true; } catch {}
      }
      // 2) Фолбэк через скрытый textarea (работает в большинстве WebView/desktop-клиентов)
      if (!ok) {
        try {
          const ta = document.createElement("textarea");
          ta.value = text;
          ta.setAttribute("readonly", "");
          ta.style.position = "fixed";
          ta.style.left = "-9999px";
          document.body.appendChild(ta);
          ta.select();
          ta.setSelectionRange(0, ta.value.length);
          ok = document.execCommand("copy");
          document.body.removeChild(ta);
        } catch {}
      }

      // Показать системный алерт Telegram (не зависит от буфера)
      try { tg?.showAlert(ok ? "Copied" : "Copy failed"); } catch {}

      // На всякий случай подсказка на экране
      if (!ok) alert("Не удалось скопировать автоматически. Выделите текст вручную и скопируйте.");
    }

    // Инициализация WebApp UI
    try {
      tg?.expand();
      tg?.ready();
      tg?.setBackgroundColor?.("#000000"); // даст чёрный фон в некоторых клиентах
      tg?.setHeaderColor?.("secondary");
      tg?.onEvent?.("themeChanged", render);
    } catch {}

    document.getElementById("copy").addEventListener("click", copyInitData);

    // Рендерим после таймаута — некоторые клиенты чуть позже прокидывают initData
    render();
    setTimeout(render, 50);
    setTimeout(render, 300);
    setTimeout(render, 1000);
  </script>
</body>
</html>
