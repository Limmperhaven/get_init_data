<!doctype html>
<html lang="ru">
<head>
  <meta charset="utf-8" />
  <meta name="viewport" content="width=device-width, initial-scale=1" />
  <title>TMA InitData demo</title>
  <style>
    /* как в гайде: подхватываем тему Telegram через CSS-переменные */
    body {
      color: var(--tg-theme-text-color);
      background: var(--tg-theme-bg-color);
      font-family: ui-sans-serif, system-ui, -apple-system, Segoe UI, Roboto, sans-serif;
      margin: 0; padding: 16px;
    }
    .wrap { max-width: 720px; margin: 0 auto; }
    h1 { margin: 0 0 12px; }
    .hint { color: var(--tg-theme-hint-color); margin-bottom: 12px; }
    pre {
      background: var(--tg-theme-secondary-bg-color);
      border: 1px solid var(--tg-theme-hint-color);
      border-radius: 12px;
      padding: 12px;
      white-space: pre-wrap; word-break: break-all;
      min-height: 120px;
    }
    button {
      margin-top: 10px; padding: 10px 16px; border: 0; border-radius: 10px;
      background: var(--tg-theme-button-color); color: var(--tg-theme-button-text-color);
      font-weight: 600; cursor: pointer;
    }
  </style>
</head>
<body>
  <div class="wrap">
    <h1>Telegram initData</h1>
    <div id="meta" class="hint">Загрузка…</div>
    <pre id="out">(empty)</pre>
    <button id="copy">Copy</button>
  </div>

  <!-- ключевая строка из гайда — подключение SDK -->
  <script src="https://telegram.org/js/telegram-web-app.js"></script>
  <script>
    const tg = window.Telegram && window.Telegram.WebApp;

    function getInitData() {
      // основной источник
      const viaAPI = tg?.initData || "";
      // запасной путь: иногда initData приходит в tgWebAppData (query)
      const viaQS = new URLSearchParams(location.search).get("tgWebAppData") || "";
      return viaAPI || viaQS || "";
    }

    function render() {
      const data = getInitData();
      out.textContent = data || "(empty)";
      meta.textContent =
        `platform: ${tg?.platform || "unknown"} | via API length: ${(tg?.initData||"").length} | via QS length: ${(new URLSearchParams(location.search).get("tgWebAppData")||"").length}`;
    }

    // полезные вызовы WebApp API
    try { tg?.expand(); tg?.ready(); } catch {}

    copy.onclick = async () => {
      const text = out.textContent;
      let ok = false;
      if (!ok && navigator.clipboard && isSecureContext) {
        try { await navigator.clipboard.writeText(text); ok = true; } catch {}
      }
      if (!ok) {
        const ta = document.createElement("textarea");
        ta.value = text; ta.setAttribute("readonly",""); ta.style.position="fixed"; ta.style.left="-9999px";
        document.body.appendChild(ta); ta.select(); ta.setSelectionRange(0, ta.value.length);
        ok = document.execCommand("copy"); document.body.removeChild(ta);
      }
      try { tg?.showAlert(ok ? "Copied" : "Copy failed"); } catch {}
    };

    render();
    // небольшой «дожим», если клиент прокидывает initData с задержкой
    setTimeout(render, 60); setTimeout(render, 300); setTimeout(render, 1000);
  </script>
</body>
</html>
